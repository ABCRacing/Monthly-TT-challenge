import json
import requests
from datetime import datetime

# URL of the leaderboard JSON
url = "https://ams2leaderboards.neocities.org/data/boards/F3%20Brasil,%20Jacarepagu%C3%A1%20Historic%202012%20SCB.json"

# List of target drivers
target_drivers = {"ACEREES", "NEIL BYWATER", "reesyboy4", "Joe"}

# Fetch the JSON data from the URL
response = requests.get(url)
if response.status_code != 200:
    print(f"Failed to fetch data: {response.status_code}")
    exit(1)

data = response.json()

# Filter entries for target drivers
filtered_entries = [entry for entry in data if entry.get("driver") in target_drivers]

# Sort entries by lap time
def parse_lap_time(lap_time_str):
    try:
        minutes, seconds = lap_time_str.split(":")
        return float(minutes) * 60 + float(seconds)
    except:
        return float('inf')  # Assign a high value if parsing fails

filtered_entries.sort(key=lambda x: parse_lap_time(x.get("lap_time", "99:99.999")))

# Update positions
for idx, entry in enumerate(filtered_entries, start=1):
    entry["position"] = str(idx)
    entry["date"] = datetime.now().strftime("%y-%m-%d %H:%M")

# Save to leaderboard.json
with open("leaderboard.json", "w") as f:
    json.dump(filtered_entries, f, indent=2)

print(f"Saved {len(filtered_entries)} results to leaderboard.json")
